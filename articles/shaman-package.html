<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The shaman package - Sampling HiC contAct Matrices for Aparametric Normalization â€¢ shaman</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="The shaman package - Sampling HiC contAct Matrices for Aparametric Normalization">
<meta property="og:description" content="shaman">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">shaman</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/shaman-package.html">
    <span class="fa fa-road"></span>
     
    Usage
  </a>
</li>
<li>
  <a href="../articles/import.html">
    <span class="fa fa-filter"></span>
     
    Import
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-th-list"></span>
     
    Reference
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.org/tanaylab/shaman" class="external-link">
    <span class="fa fa-github-square"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>The shaman package - Sampling HiC contAct Matrices for Aparametric Normalization</h1>
                        <h4 data-toc-skip class="author">Netta Mendelson Cohen</h4>
            
            <h4 data-toc-skip class="date">2022-03-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/tanaylab/shaman/blob/HEAD/vignettes/shaman-package.Rmd" class="external-link"><code>vignettes/shaman-package.Rmd</code></a></small>
      <div class="hidden name"><code>shaman-package.Rmd</code></div>

    </div>

    
    
<p>Shaman package impelements functions for resampling Hi-C matrices in order to generate expected contact distributions given constraints on marginal coverage and contact-distance probability distributions. The package also provides support for visualizing normalized matrices and statistical analysis of contact distributions around selected landmarks. It is an R package embedding algorithms implemened in C++, which is built over support from the Tanay's lab <em>Misha</em> genomic database system that is provided with the package.</p>
<p>The normalization workflow consists of the following steps:</p>
<ol style="list-style-type: decimal">
<li>
<a href="https://tanaylab.github.io/shaman/articles/import.html" class="external-link">Import</a> observed HiC data to misha db. In order to utilize full functionality of the shaman package, you need to construct a Misha database for your genome of interest, and import your Hi-C data to Misha binary Quad-tree format.</li>
<li>Shuffle observed data to generate expected data. Reshuffling of an entire dataset will require 7 hours per 1 billion reads on a machine with one core per chromosome. Note that shaman can also run distributed using Sun Grid Engine.</li>
<li>Compute the normalized score of each observed data point. This computation can be conducted inline for a specific genomic region, or pre-processed on the entire dataset using distributed computation. Score computation on 1 billion reads on a distributed system may take 4-10 hours, depending on the number of cores available.</li>
<li>Visualize normalized contact maps. Precomputed normalized scores allow for flexible analysis of contact distributions.</li>
<li>Quantify contact enrichment acoording to genomic features.</li>
</ol>
<p>In the example misha database provided in this package we have created a low-footprint matrix to examplify the shaman workflow. We included 4.6 million contacts from ELA K562 dataset covering the hoxd locus (chr2:175e06-178e06) and convergent CTCF regions. Processing the complete matrix from this study requires downloading the full contact list and regenerating the reshuffled matrix.</p>
<div class="section level2">
<h2 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h2>
<p>Once an observed HiC dataset is available in the misha db (refere to <a href="https://tanaylab.github.io/shaman/articles/import.html" class="external-link">Import</a>) for additional information), there are two possible modes to continue analysis: 1. Distributed computation - relying on sun grid engine (sge), or using a single machine with multi-cores. 2. Local computation - for computing normalized matrices in small genomic regions</p>
<div class="section level3">
<h3 id="distributed-mode">Distributed mode<a class="anchor" aria-label="anchor" href="#distributed-mode"></a>
</h3>
<ul>
<li>Set configuration parameter "shaman.sge_support" for sge or "shaman.mc_support" for multi-core to 1.</li>
</ul>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>shaman.mc_support<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<ul>
<li>Generate expected HiC misha 2D track</li>
</ul>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/shaman_shuffle_hic_track.html">shaman_shuffle_hic_track</a></span><span class="op">(</span>track_db<span class="op">=</span><span class="fu"><a href="../reference/shaman_get_test_track_db.html">shaman_get_test_track_db</a></span><span class="op">(</span><span class="op">)</span>, obs_track_nm<span class="op">=</span><span class="st">"hic_obs"</span>, work_dir<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<ul>
<li>Generate score 2D track</li>
</ul>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/shaman_score_hic_track.html">shaman_score_hic_track</a></span><span class="op">(</span>track_db<span class="op">=</span><span class="fu"><a href="../reference/shaman_get_test_track_db.html">shaman_get_test_track_db</a></span><span class="op">(</span><span class="op">)</span>, work_dir<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, score_track_nm<span class="op">=</span><span class="st">"hic_score_new"</span>, obs_track_nms<span class="op">=</span><span class="st">"hic_obs"</span><span class="op">)</span></code></pre></div>
<ul>
<li>Visualize region</li>
</ul>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">gsetroot</span><span class="op">(</span><span class="fu"><a href="../reference/shaman_get_test_track_db.html">shaman_get_test_track_db</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">point_score</span> <span class="op">=</span> <span class="fu">gextract</span><span class="op">(</span><span class="st">"hic_score"</span>, <span class="fu">gintervals.2d</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">175e06</span>, <span class="fl">178e06</span>, <span class="fl">2</span>, <span class="fl">175e06</span>, <span class="fl">178e06</span><span class="op">)</span>, colnames<span class="op">=</span><span class="st">"score"</span><span class="op">)</span>
<span class="fu"><a href="../reference/shaman_plot_map_score_with_annotations.html">shaman_plot_map_score_with_annotations</a></span><span class="op">(</span><span class="st">"hg19"</span>, <span class="va">point_score</span>, <span class="fu">gintervals</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">175e06</span>, <span class="fl">178e06</span><span class="op">)</span>, misha_tracks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"K562.k27ac"</span>, <span class="st">"rna-seq"</span><span class="op">)</span>, annotations<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"ctcf_forward"</span>, <span class="st">"ctcf_reverse"</span><span class="op">)</span>, a_colors<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#4572A7"</span>, <span class="st">"#AA4643"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="fig2.hoxd.example.png" alt="Example of normalized map with annotations"><p class="caption">Example of normalized map with annotations</p>
</div>
</div>
<div class="section level3">
<h3 id="local-mode">Local mode<a class="anchor" aria-label="anchor" href="#local-mode"></a>
</h3>
<ul>
<li>Generating an expected matrix and computing its score for a given interval: a local computation is possible on a small region:</li>
</ul>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">point_score</span> <span class="op">=</span> <span class="fu"><a href="../reference/shaman_shuffle_and_score_hic_mat.html">shaman_shuffle_and_score_hic_mat</a></span><span class="op">(</span>obs_track_nms<span class="op">=</span><span class="st">"obs"</span>, interval<span class="op">=</span><span class="va">interval</span>, work_dir<span class="op">=</span><span class="st">"work_dir"</span><span class="op">)</span></code></pre></div>
<ul>
<li>Visualize region</li>
</ul>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/shaman_plot_map_score_with_annotations.html">shaman_plot_map_score_with_annotations</a></span><span class="op">(</span><span class="st">"hg19"</span>, <span class="va">point_score</span><span class="op">$</span><span class="va">points</span>, <span class="va">region</span>, misha_tracks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"K56.k27ac"</span>, <span class="st">"rna-seq"</span><span class="op">)</span>, annotations<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"ctcf_pos"</span>, <span class="st">"ctcf_neg"</span><span class="op">)</span>, a_colors<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#4572A7"</span>, <span class="st">"#AA4643"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="analysis">Analysis<a class="anchor" aria-label="anchor" href="#analysis"></a>
</h2>
<div class="section level3">
<h3 id="spatial-contact-enrichment---used-to-measure-contact-enrichemnt-between-two-sets-of-genomic-features-">Spatial contact enrichment - used to measure contact enrichemnt between two sets of genomic features.<a class="anchor" aria-label="anchor" href="#spatial-contact-enrichment---used-to-measure-contact-enrichemnt-between-two-sets-of-genomic-features-"></a>
</h3>
<p>Relies on an existance of an expected (shuffled) 2d track. Builds a grid comprising of all combinations of intervals from feature 1 and feature 2 that fall within a band defined by min_dist and max_dist. For each point on the grid, look at th surrounding window, defined by range parameter. Discard all windows that do not contain a point with a score (defined in scotre_track_nm) above the score_filter parameter. This allows for focusing on potentially enriched pairs. Discect the window into small bins, size in base pairs defined by the resolution parameter, and count the number of observed contacts, and the number of expected contacts in each bin. All windows are then summed together, generating a single matrix of observed and expected contacts, which is returned by function. Note that grid contains only points in which feature 1 position is smaller than feature 2 position.</p>
<p>Create data grid for two sets of features, and visualize it:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">grid</span> <span class="op">=</span> <span class="fu"><a href="../reference/shaman_generate_feature_grid.html">shaman_generate_feature_grid</a></span><span class="op">(</span><span class="va">feature1</span>, <span class="va">feature2</span>, <span class="va">obs_track</span>, <span class="va">exp_track</span>, range<span class="op">=</span><span class="fl">25000</span>, resolution<span class="op">=</span><span class="fl">500</span><span class="op">)</span>
<span class="fu"><a href="../reference/shaman_plot_feature_grid.html">shaman_plot_feature_grid</a></span><span class="op">(</span><span class="va">grid</span>, range<span class="op">=</span><span class="fl">25000</span>, grid_resolution<span class="op">=</span><span class="fl">500</span>, plot_resolution<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="hic.K562.ela_k562.ctcf_neg.ctcf_pos.1k.png" alt="Example of spatial contact enrichment for converging CTCF pairs: log10(obs) on the left, log2(obs/exp) on the right"><p class="caption">Example of spatial contact enrichment for converging CTCF pairs: log10(obs) on the left, log2(obs/exp) on the right</p>
</div>
</div>
<div class="section level3">
<h3 id="options">Options<a class="anchor" aria-label="anchor" href="#options"></a>
</h3>
<p>The following options are available for this package:</p>
<div class="section level4">
<h4 id="system-parameters">System parameters<a class="anchor" aria-label="anchor" href="#system-parameters"></a>
</h4>
<ul>
<li>shaman.mc_support = 0 - Set to 1 if multi-core is available for distributed computing.</li>
<li>shaman.sge_support = 0 - Set to 1 if Sun Grid Engine is available for distributed computing.</li>
<li>shaman.sge_flags = "" - SGE paramters to be passed to qsub (e.g. threads, queue, etc'). Note that for some shaman package methods either muli-core or sge support is required.</li>
</ul>
</div>
<div class="section level4">
<h4 id="visualization-parameters">Visualization parameters<a class="anchor" aria-label="anchor" href="#visualization-parameters"></a>
</h4>
<ul>
<li>shaman.score_pal_0_col = 'lightgrey' - the color to display zero score points, points that are not enriched or depleted in contacts</li>
<li>shaman.score_pal_pos_col = c('lightgrey', 'pink', 'red', 'orange', 'yellow') - the color palette to use for contact enrichment (from low to high)</li>
<li>shaman.score_pal_neg_col = c('lightgrey', 'lightblue', 'blue', 'black') - the color palette to use for contact depletion (from low to high)</li>
</ul>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Amos Tanay, Netta Mendelson Cohen.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
